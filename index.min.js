'use strict';var m = require("enot"), n = require("mutypes"), p = require("each-csv");
module.exports = q;
var t = n.isObject, u = n.has, v = n.isFn, w = n.isPlain, x = m.on, y = m.off, z = "before", A = "after", B = "init", D = "changed", E = "set", F = "get", G = "_", H = new WeakMap, I = new WeakMap, J = new WeakMap;
function q(b, a) {
  H.has(b) || H.set(b, {});
  I.has(b) || I.set(b, {});
  L(a, !0);
  var c = {};
  J.set(b, c);
  for (var d in a) {
    c[d] = c[d] || {};
    var f = a[d];
    if (t(f)) {
      for (var e in f) {
        var C = f[e];
        if (t(C)) {
          for (var r in C) {
            if (!M(r) && r !== d) {
              var S = C[r];
              (c[r] = c[r] || {})[d] = !0;
              u(b, r) || u(a, r) || v(S) && (b[r] = N);
            }
          }
        }
      }
    }
  }
  O(b, a, c);
  for (d in c) {
    P(b, d);
  }
  return b;
}
function O(b, a, c) {
  var d = {}, f;
  for (f in c) {
    t(a[f]) || (d[f] = a[f]);
  }
  H.set(b, Object.create(d));
  for (var e in c) {
    c = a[e], I.get(b)[e] = Object.create(t(c) ? c : null), u(b, e) && (H.get(b)[e] = b[e]), Q(b, B + e), Object.defineProperty(b, e, {get:function(b, a) {
      return function() {
        var c = I.get(a)[b], d = H.get(a)[b];
        P(a, b);
        c = R(a, c[F], d);
        void 0 !== c && (d = c);
        return d;
      };
    }(e, b), set:function(b, a) {
      return function(c) {
        var d = I.get(a)[b], e = H.get(a);
        P(a, b);
        var f = e[b], g = R(a, d[E], c, f);
        void 0 !== g && (c = g);
        if (!T(a, B + b)) {
          if (c === f) {
            return;
          }
          g = u(d, f) ? d[f] : d[G];
          if (!Q(a, A + g)) {
            var h;
            h = c;
            h = g ? g[A] ? v(g[A]) ? g[A].call(a, h) : void 0 : g[A] : h;
            if (void 0 !== h && h !== c) {
              return!1 !== h && (a[b] = h), T(a, A + g);
            }
            T(a, A + g);
            if (e[b] !== f) {
              return;
            }
            if (g) {
              for (var l in g) {
                if (!M[l]) {
                  h = g[l];
                  var V = I.get(a)[l], W = H.get(a);
                  if (t(h)) {
                    for (var s in h) {
                      delete V[s];
                    }
                  } else {
                    y(a, l, h), delete W[l];
                  }
                }
              }
            }
          }
        }
        e[b] = c;
        e = u(d, c) ? c : G;
        if (!Q(a, e)) {
          if (l = d[e]) {
            for (var k in l) {
              if (!M(k)) {
                if (s = l[k], g = I.get(a)[k], t(s)) {
                  for (var K in s) {
                    g[K] = s[K];
                  }
                } else {
                  x(a, k, s), a[k] = s;
                }
              }
            }
          }
          k = R(a, l, c, f);
          if (void 0 !== k && k !== c) {
            return a[b] = !1 === k ? f : k, T(a, e);
          }
          T(a, e);
        }
        c !== f && R(a, d[D], c, f);
      };
    }(e, b)});
  }
}
function P(b, a) {
  var c = J.get(b);
  if (c[a]) {
    var d = I.get(b)[a], f = H.get(b), e;
    for (e in c[a]) {
      c[a][e] && P(b, e);
    }
    c[a] = null;
    c = R(b, d[B], f[a]);
    void 0 !== c && (v(c) && (c = c.bind(b)), x(b, a, c));
    b[a] = c;
  }
}
new WeakMap;
function R(b, a, c, d) {
  if (void 0 === a) {
    return c;
  }
  if (!w(a)) {
    if (v(a)) {
      return a.call(b, c, d);
    }
    if (t(a)) {
      return v(a[z]) ? a[z].call(b, c, d) : a[z];
    }
  }
  return a;
}
function N() {
}
function M(b) {
  if (b === z || b === A) {
    return!0;
  }
}
var U = new WeakMap;
function Q(b, a) {
  U.get(b) || U.set(b, {});
  if (U.get(b)[a]) {
    return!0;
  }
  U.get(b)[a] = !0;
  return!1;
}
function T(b, a) {
  var c = !1;
  U.get(b)[a] && (c = !0);
  U.get(b)[a] = null;
  return c;
}
function L(b, a) {
  for (var c in b) {
    var d = b[c];
    a && t(d) && L(d, a);
    /,/.test(c) && (delete b[c], p(c, function(a) {
      b[a] = d;
    }));
  }
}
;
